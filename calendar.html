{% extends "base.html" %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h2><i class="fas fa-calendar-alt"></i> Group Schedule</h2>
        <button class="btn-primary" id="add-event-btn" style="width: auto;">+ Add Event</button>
    </div>

    <div id="calendar"></div>

    <!-- Add Event Modal -->
    <div id="event-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 style="margin-bottom: 20px;">Add New Event</h3>
            <form id="event-form">
                <div class="form-group">
                    <label>Title</label>
                    <input type="text" id="event-title" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="event-type"
                        style="width: 100%; padding: 10px; background: #333; color: #fff; border: 1px solid #444; border-radius: 6px;">
                        <option value="assignment">Assignment</option>
                        <option value="test">Test</option>
                        <option value="study">Study Session</option>
                        <option value="social">Social</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="datetime-local" id="event-start" required>
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="datetime-local" id="event-end">
                </div>
                <button type="submit" class="btn-primary">Save Event</button>
            </form>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            themeSystem: 'standard',
            height: 'auto',
            events: '/api/events'
        });
        calendar.render();

        // Modal Logic
        var modal = document.getElementById("event-modal");
        var btn = document.getElementById("add-event-btn");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function () { modal.style.display = "block"; }
        span.onclick = function () { modal.style.display = "none"; }
        window.onclick = function (event) {
            if (event.target == modal) { modal.style.display = "none"; }
        }

        // Form Submit
        document.getElementById('event-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const data = {
                title: document.getElementById('event-title').value,
                type: document.getElementById('event-type').value,
                start: document.getElementById('event-start').value,
                end: document.getElementById('event-end').value
            };

            fetch('/api/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            }).then(res => res.json()).then(data => {
                if (data.status === 'success') {
                    calendar.refetchEvents();
                    modal.style.display = "none";
                    document.getElementById('event-form').reset();
                }
            });
        });
    });
</script>

<style>
    /* Inline modal styles for simplicity */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
    }

    .modal-content {
        background-color: #252525;
        margin: 15% auto;
        padding: 30px;
        border: 1px solid #444;
        width: 400px;
        border-radius: 12px;
        position: relative;
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .close:hover {
        color: #fff;
    }

    /* Calendar Overrides */
    .fc {
        color: var(--text-primary);
    }

    .fc-col-header-cell {
        background: #333;
    }

    .fc-daygrid-day {
        border-color: #444;
    }
</style>
{% endblock %}